<config-template xmlns="http://tail-f.com/ns/config/1.0">
    <?save-context service?>
    <?set NETWORK_VLAN_NAME = {concat(string(tenant), ':', string(name), ':', 'network-vlan')}?>
    <?set VRF_VLAN_NAME = {concat(string(tenant), ':', string(vrf), ':', 'vrf-vlan')}?>
    <?set VRF = {string(vrf)}?>
    <?set MCAST_GROUP = {string(mcast-group)}?>
    <?set AS_NUMBER = {string(as-number)}?>
    <?set L3_SERVICE = {bd-subnet}?>
    <devices xmlns="http://tail-f.com/ns/ncs">
        <?foreach {device}?>
        <?save-context device?>
        <device>
            <name>{leaf-id}</name>
            <config>
                <vlan xmlns="http://tail-f.com/ned/cisco-nx">
                    <vlan-list>
                        <id>{network-vlan}</id>
                        <name>{$NETWORK_VLAN_NAME}</name>
                        <vn-segment>{l2vni}</vn-segment>
                    </vlan-list>
                    <?if {boolean($L3_SERVICE)}?>
                    <vlan-list>
                        <id>{vrf-vlan}</id>
                        <name>{$VRF_VLAN_NAME}</name>
                        <vn-segment>{l3vni}</vn-segment>
                    </vlan-list>
                    <?end ?>
                </vlan>
                <evpn xmlns="http://tail-f.com/ned/cisco-nx">
                    <vni>
                        <id>{l2vni}</id>
                        <l2 />
                        <rd>auto</rd>
                        <route-target>
                            <method>import</method>
                            <rt>auto</rt>
                        </route-target>
                        <route-target>
                            <method>export</method>
                            <rt>auto</rt>
                        </route-target>
                    </vni>
                </evpn>
                <?if {boolean($L3_SERVICE)}?>
                <vrf xmlns="http://tail-f.com/ned/cisco-nx">
                    <context>
                        <id>{$VRF}</id>
                        <vni>{l3vni}</vni>
                        <rd>auto</rd>
                        <address-family>
                            <ipv4>
                                <unicast>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>evpn</target-evpn>
                                    </route-target>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>non-evpn</target-evpn>
                                    </route-target>
                                </unicast>
                            </ipv4>
                            <ipv6>
                                <unicast>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>evpn</target-evpn>
                                    </route-target>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>non-evpn</target-evpn>
                                    </route-target>
                                </unicast>
                            </ipv6>
                        </address-family>
                    </context>
                </vrf>
                <router xmlns="http://tail-f.com/ned/cisco-nx">
                    <bgp>
                        <id>{$AS_NUMBER}</id>
                        <vrf>
                            <name>{$VRF}</name>
                            <address-family>
                                <proto>ipv4</proto>
                                <type>unicast</type>
                                <advertise>
                                    <l2vpn>evpn</l2vpn>
                                </advertise>
                                <maximum-paths>
                                    <ibgp>2</ibgp>
                                </maximum-paths>
                                <redistribute>
                                    <direct>
                                        <route-map>fabric-rmap-redist-subnet</route-map>
                                    </direct>
                                </redistribute>
                            </address-family>
                            <address-family>
                                <proto>ipv6</proto>
                                <type>unicast</type>
                                <advertise>
                                    <l2vpn>evpn</l2vpn>
                                </advertise>
                                <maximum-paths>
                                    <ibgp>2</ibgp>
                                </maximum-paths>
                                <redistribute>
                                    <direct>
                                        <route-map>fabric-rmap-redist-subnet</route-map>
                                    </direct>
                                </redistribute>
                            </address-family>
                        </vrf>
                    </bgp>
                </router>
                <interface xmlns="http://tail-f.com/ned/cisco-nx">
                    <Vlan>
                        <name>{network-vlan}</name>
                        <vrf>
                            <member>{$VRF}</member>
                        </vrf>
                        <?switch-context service?>
                        <?foreach {bd-subnet}?>
                        <ip>
                            <?if {string(preferred) = 'yes'}?>
                            <address>
                                <ipaddr>{address}</ipaddr>
                            </address>
                            <?else ?>
                            <secondary-addr>
                                <address>
                                    <ipaddr>{address}</ipaddr>
                                    <secaddr>secondary</secaddr>
                                </address>
                            </secondary-addr>
                            <?end ?>
                        </ip>
                        <?end ?>
                        <?switch-context device?>
                        <fabric>
                            <forwarding>
                                <mode>anycast-gateway</mode>
                            </forwarding>
                        </fabric>
                    </Vlan>
                    <Vlan>
                        <name>{vrf-vlan}</name>
                        <vrf>
                            <member>{$VRF}</member>
                        </vrf>
                        <ip>
                            <forward />
                            <redirects>false</redirects>
                        </ip>
                        <ipv6>
                            <redirects>false</redirects>
                        </ipv6>
                    </Vlan>
                </interface>
                <?end ?>
                <interface xmlns="http://tail-f.com/ned/cisco-nx">
                    <nve>
                        <name>1</name>
                        <member>
                            <vni>
                                <id>{l2vni}</id>
                                <mcast-group>{$MCAST_GROUP}</mcast-group>
                                <?if {boolean($L3_SERVICE)}?>
                                <suppress-arp />
                                <?end ?>
                            </vni>
                            <?if {boolean($L3_SERVICE)}?>
                            <vni>
                                <id>{l3vni}</id>
                                <associate-vrf />
                            </vni>
                            <?end ?>
                        </member>
                    </nve>
                </interface>
            </config>
        </device>
        <?end ?>
    </devices>
</config-template>