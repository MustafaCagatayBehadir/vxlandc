<config-template xmlns="http://tail-f.com/ns/config/1.0">
    <?save-context service?>
    <?set VRF = {string(name)}?>
    <?set VRF_VLAN_NAME = {concat($VRF, ':', 'vrf-vlan')}?>
    <?set AS_NUMBER = {string(as-number)}?>
    <devices xmlns="http://tail-f.com/ns/ncs">
        <?foreach {device}?>
            <device>
            <name>{leaf-id}</name>
            <config>
                <?switch-context service?>
                <vlan xmlns="http://tail-f.com/ned/cisco-nx">
                    <vlan-list>
                        <id>{vlan-id}</id>
                        <name>{$VRF_VLAN_NAME}</name>
                        <vn-segment>{vni-id}</vn-segment>
                    </vlan-list>
                </vlan>
                <vrf xmlns="http://tail-f.com/ned/cisco-nx">
                    <context>
                        <id>{$VRF}</id>
                        <vni>{vni-id}</vni>
                        <rd>auto</rd>
                        <address-family>
                            <ipv4>
                                <unicast>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>evpn</target-evpn>
                                    </route-target>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>non-evpn</target-evpn>
                                    </route-target>
                                </unicast>
                            </ipv4>
                            <ipv6>
                                <unicast>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>evpn</target-evpn>
                                    </route-target>
                                    <route-target>
                                        <method>both</method>
                                        <asn>auto</asn>
                                        <target-evpn>non-evpn</target-evpn>
                                    </route-target>
                                </unicast>
                            </ipv6>
                        </address-family>
                    </context>
                </vrf>
                <router xmlns="http://tail-f.com/ned/cisco-nx">
                    <bgp>
                        <id>{$AS_NUMBER}</id>
                        <vrf>
                            <name>{$VRF}</name>
                            <address-family>
                                <proto>ipv4</proto>
                                <type>unicast</type>
                                <advertise>
                                    <l2vpn>evpn</l2vpn>
                                </advertise>
                                <maximum-paths>
                                    <ibgp>2</ibgp>
                                </maximum-paths>
                                <redistribute>
                                    <?if {direct}?>
                                        <direct>
                                            <?if {direct/address-family-ipv4-policy}?>
                                                <route-map>{direct/address-family-ipv4-policy}</route-map>
                                            <?end?>
                                        </direct>
                                    <?end?>
                                    <?if {static}?>
                                        <static>
                                            <?if {static/address-family-ipv4-policy}?>
                                                <route-map>{static/address-family-ipv4-policy}</route-map>
                                            <?end?>
                                        </static>                                    
                                    <?end?>
                                </redistribute>
                            </address-family>
                            <address-family>
                                <proto>ipv6</proto>
                                <type>unicast</type>
                                <advertise>
                                    <l2vpn>evpn</l2vpn>
                                </advertise>
                                <maximum-paths>
                                    <ibgp>2</ibgp>
                                </maximum-paths>
                                <redistribute>
                                    <?if {direct}?>
                                        <direct>
                                            <?if {direct/address-family-ipv6-policy}?>
                                                <route-map>{direct/address-family-ipv6-policy}</route-map>
                                            <?end?>
                                        </direct>
                                    <?end?>
                                    <?if {static}?>
                                        <static>
                                            <?if {static/address-family-ipv6-policy}?>
                                                <route-map>{static/address-family-ipv6-policy}</route-map>
                                            <?end?>
                                        </static>                                    
                                    <?end?>
                                </redistribute>
                            </address-family>
                        </vrf>
                    </bgp>
                </router>
                <interface xmlns="http://tail-f.com/ned/cisco-nx">
                    <Vlan>
                        <name>{vlan-id}</name>
                        <vrf>
                            <member>{$VRF}</member>
                        </vrf>
                        <ip>
                            <forward />
                            <redirects>false</redirects>
                        </ip>
                        <ipv6>
                            <redirects>false</redirects>
                        </ipv6>
                    </Vlan>
                </interface>
                <interface xmlns="http://tail-f.com/ned/cisco-nx">
                    <nve>
                        <name>1</name>
                        <member>
                            <vni>
                                <id>{vni-id}</id>
                                <associate-vrf />
                            </vni>
                        </member>
                    </nve>
                </interface>
            </config>
        </device>
        <?end ?>
    </devices>
</config-template>