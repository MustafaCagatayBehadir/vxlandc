<config-template xmlns="http://tail-f.com/ns/config/1.0">
    <?save-context service?>
    <?set NETWORK_VLAN_NAME = {concat(string(name), ':', 'network-vlan')}?>
    <?set VRF = {string(vrf)}?>
    <?set MCAST_GROUP = {string(mcast-group)}?>
    <?set L3_SERVICE = {bd-subnet}?>
    <devices xmlns="http://tail-f.com/ns/ncs">
        <?foreach {device}?>
            <?save-context device?>
            <device>
                <name>{leaf-id}</name>
                <config>
                    <vlan xmlns="http://tail-f.com/ned/cisco-nx">
                        <vlan-list>
                            <id>{network-vlan}</id>
                            <name>{$NETWORK_VLAN_NAME}</name>
                            <vn-segment>{l2vni}</vn-segment>
                        </vlan-list>
                    </vlan>
                    <evpn xmlns="http://tail-f.com/ned/cisco-nx">
                        <vni>
                            <id>{l2vni}</id>
                            <l2 />
                            <rd>auto</rd>
                            <route-target>
                                <method>import</method>
                                <rt>auto</rt>
                            </route-target>
                            <route-target>
                                <method>export</method>
                                <rt>auto</rt>
                            </route-target>
                        </vni>
                    </evpn>
                    <?if {boolean($L3_SERVICE)}?>
                        <interface xmlns="http://tail-f.com/ned/cisco-nx">
                            <Vlan>
                                <name>{network-vlan}</name>
                                <vrf>
                                    <member>{$VRF}</member>
                                </vrf>
                                <?switch-context service?>
                                <?foreach {bd-subnet}?>
                                    <ip>
                                        <?if {string(preferred) = 'yes'}?>
                                        <address>
                                            <ipaddr>{address}</ipaddr>
                                        </address>
                                        <?else?>
                                        <secondary-addr>
                                            <address>
                                                <ipaddr>{address}</ipaddr>
                                                <secaddr>secondary</secaddr>
                                            </address>
                                        </secondary-addr>
                                        <?end?>
                                    </ip>
                                <?end?>
                                <?switch-context device?>
                                <fabric>
                                    <forwarding>
                                        <mode>anycast-gateway</mode>
                                    </forwarding>
                                </fabric>
                            </Vlan>
                        </interface>
                    <?end?>
                    <interface xmlns="http://tail-f.com/ned/cisco-nx">
                        <nve>
                            <name>1</name>
                            <member>
                                <vni>
                                    <id>{l2vni}</id>
                                    <mcast-group>{$MCAST_GROUP}</mcast-group>
                                    <?if {boolean($L3_SERVICE)}?>
                                        <suppress-arp />
                                    <?end?>
                                </vni>
                            </member>
                        </nve>
                    </interface>
                </config>
            </device>
        <?end?>
    </devices>
</config-template>